<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOC Simulator - Final</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons for UI elements -->
    <script src="https://unpkg.com/lucide@0.320.0/dist/umd/lucide.min.js"></script>

    <!-- Chart.js for dashboard visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Custom Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles to enhance the SIEM look and feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
        }
        .sidebar-icon {
            stroke-width: 1.5;
        }
        /* Custom scrollbar for a more integrated look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; /* bg-gray-800 */ }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; /* bg-gray-600 */ }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; /* bg-gray-500 */ }
        /* Style for active navigation link */
        .nav-link.active { background-color: #374151; color: #ffffff; font-weight: 600; /* bg-gray-700 */ }
        /* Blinking dot for new alerts */
        .blinking-dot { animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }
        /* Loading spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .log-line span { margin-right: 8px; }
        .log-line .timestamp { color: #6ee7b7; } /* text-teal-300 */
        .log-line .source { color: #fca5a5; } /* text-red-300 */
        .log-line .message { color: #d1d5db; }
        .log-line .highlight { color: #facc15; font-weight: bold; } /* text-yellow-400 */
        
        /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .toast {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #1f2937; /* bg-gray-800 */
            color: #f9fafb; /* text-gray-50 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateX(120%);
            transition: transform 0.5s ease-in-out;
        }
        .toast.show {
            transform: translateX(0);
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar Navigation -->
    <aside class="w-16 md:w-64 bg-gray-900/70 backdrop-blur-sm border-r border-gray-700 flex flex-col transition-all duration-300">
        <div class="flex items-center justify-center md:justify-start md:px-4 h-16 border-b border-gray-700 shrink-0">
            <i data-lucide="shield-check" class="h-8 w-8 text-indigo-400"></i>
            <span class="hidden md:inline ml-3 text-xl font-bold text-white">SOC Sim</span>
        </div>
        <nav class="flex-grow p-2 space-y-2">
            <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors duration-200" data-view="dashboard">
                <i data-lucide="layout-dashboard" class="sidebar-icon h-6 w-6"></i>
                <span class="hidden md:inline ml-4 font-medium">Dashboard</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors duration-200 active" data-view="alerts">
                <i data-lucide="bell-ring" class="sidebar-icon h-6 w-6"></i>
                <span class="hidden md:inline ml-4 font-medium">Alerts</span>
                <span id="alert-count-badge" class="hidden md:inline ml-auto bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full">0</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors duration-200" data-view="search">
                <i data-lucide="search" class="sidebar-icon h-6 w-6"></i>
                <span class="hidden md:inline ml-4 font-medium">Log Search</span>
            </a>
             <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors duration-200" data-view="threatintel">
                <i data-lucide="server" class="sidebar-icon h-6 w-6"></i>
                <span class="hidden md:inline ml-4 font-medium">Threat Intel</span>
            </a>
             <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors duration-200" data-view="profile">
                <i data-lucide="user-circle" class="sidebar-icon h-6 w-6"></i>
                <span class="hidden md:inline ml-4 font-medium">Profile</span>
            </a>
        </nav>
        <div class="p-2 border-t border-gray-700">
             <a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors duration-200" data-view="settings">
                <i data-lucide="settings" class="sidebar-icon h-6 w-6"></i>
                <span class="hidden md:inline ml-4 font-medium">Settings</span>
            </a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col bg-gray-900 overflow-hidden">
        
        <!-- Alerts View -->
        <div id="view-alerts" class="view flex flex-col h-full">
            <header class="flex items-center justify-between p-4 border-b border-gray-800 bg-gray-900/50 backdrop-blur-sm shrink-0">
                <h1 class="text-2xl font-bold text-white">Security Alerts</h1>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-sm">
                         <div id="feed-status-indicator" class="h-3 w-3 rounded-full bg-green-500 blinking-dot"></div>
                         <span id="feed-status-text">Real-time Feed Active</span>
                    </div>
                    <button id="toggle-feed-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">Pause Feed</button>
                </div>
            </header>
            <div class="flex-1 overflow-y-auto">
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-800 sticky top-0">
                        <tr>
                            <th scope="col" class="px-6 py-3 w-1/12">Status</th>
                            <th scope="col" class="px-6 py-3 w-1/12">Severity</th>
                            <th scope="col" class="px-6 py-3 w-2/12">Timestamp</th>
                            <th scope="col" class="px-6 py-3 w-4/12">Description</th>
                            <th scope="col" class="px-6 py-3 w-2/12">Source IP</th>
                            <th scope="col" class="px-6 py-3 w-2/12">Destination IP</th>
                        </tr>
                    </thead>
                    <tbody id="alerts-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="view-dashboard" class="view hidden p-6 overflow-y-auto">
             <h1 class="text-2xl font-bold text-white mb-6">Operations Dashboard</h1>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-gray-800 p-5 rounded-lg shadow-lg flex items-center"><i data-lucide="siren" class="h-10 w-10 text-blue-400 mr-4"></i><div><p class="text-gray-400 text-sm">Total Alerts (24h)</p><p id="kpi-total-alerts" class="text-2xl font-bold text-white">0</p></div></div>
                <div class="bg-gray-800 p-5 rounded-lg shadow-lg flex items-center"><i data-lucide="folder-open" class="h-10 w-10 text-yellow-400 mr-4"></i><div><p class="text-gray-400 text-sm">Open Cases</p><p id="kpi-open-cases" class="text-2xl font-bold text-white">0</p></div></div>
                <div class="bg-gray-800 p-5 rounded-lg shadow-lg flex items-center"><i data-lucide="timer" class="h-10 w-10 text-green-400 mr-4"></i><div><p class="text-gray-400 text-sm">Avg. Resolution Time</p><p id="kpi-avg-resolution" class="text-2xl font-bold text-white">N/A</p></div></div>
             </div>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-gray-800 p-4 rounded-lg shadow-lg"><h2 class="text-lg font-semibold text-white mb-2">Alerts Over Time</h2><div class="h-80"><canvas id="timelineChart"></canvas></div></div>
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h2 class="text-lg font-semibold text-white mb-2">Alerts by Severity</h2><div class="h-80"><canvas id="severityChart"></canvas></div></div>
                <div class="lg:col-span-3 bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-lg font-semibold text-white mb-4">Live Threat Picture</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><h3 class="font-semibold mb-2">Top Attackers (IP)</h3><ul id="top-attackers-list" class="space-y-2 text-sm"></ul></div>
                        <div><h3 class="font-semibold mb-2">Top Targets (IP)</h3><ul id="top-targets-list" class="space-y-2 text-sm"></ul></div>
                        <div><h3 class="font-semibold mb-2">Recent High Severity Cases</h3><ul id="recent-cases-list" class="space-y-2 text-sm"></ul></div>
                    </div>
                </div>
             </div>
        </div>
        
        <!-- Search View -->
        <div id="view-search" class="view hidden p-6 overflow-y-auto">
             <h1 class="text-2xl font-bold text-white mb-6">Log Search</h1>
             <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <div class="flex space-x-2">
                    <input type="text" id="search-query-input" placeholder="Search logs... (e.g., src_ip=198.51.100.82 or malware)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <button id="search-logs-btn" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">Search</button>
                </div>
                <div id="search-results-container" class="mt-4 bg-gray-900 p-4 rounded-lg max-h-[70vh] overflow-y-auto hidden"><pre class="text-xs text-gray-300"></pre></div>
             </div>
        </div>
        
        <!-- Threat Intel View -->
        <div id="view-threatintel" class="view hidden p-6 overflow-y-auto">
            <h1 class="text-2xl font-bold text-white mb-6">Threat Intelligence Center</h1>
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-lg font-semibold text-white mb-4">Unified Indicator Lookup</h2>
                <div class="flex space-x-2">
                    <input type="text" id="unified-lookup-input" placeholder="Enter IP, URL, Hash, or Domain..." class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <button id="unified-lookup-btn" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">Lookup</button>
                </div>
                <div id="unified-lookup-results" class="mt-4 hidden"></div>
            </div>
        </div>

        <!-- Profile View -->
        <div id="view-profile" class="view hidden p-6 overflow-y-auto">
            <h1 class="text-2xl font-bold text-white mb-6">Analyst Profile</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-gray-800 p-6 rounded-lg shadow-lg text-center">
                    <img src="https://placehold.co/128x128/7e22ce/ffffff?text=SA" alt="Analyst Avatar" class="h-32 w-32 rounded-full mx-auto mb-4 border-4 border-indigo-500">
                    <h2 class="text-2xl font-bold text-white">S. Analyst</h2>
                    <p class="text-indigo-400">Tier 1 Analyst</p>
                    <div class="mt-4">
                        <p class="text-gray-400">Level <span id="profile-level" class="font-bold text-xl text-white">1</span></p>
                        <div class="w-full bg-gray-700 rounded-full h-4 mt-2">
                            <div id="profile-xp-bar" class="bg-indigo-600 h-4 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="profile-xp-text" class="text-sm text-gray-400 mt-1">0 / 100 XP</p>
                    </div>
                </div>
                <div class="md:col-span-2 bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">Achievements</h2>
                    <ul id="achievements-list" class="space-y-4">
                       <!-- Achievements will be populated here -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div id="view-settings" class="view hidden p-6 overflow-y-auto">
            <h1 class="text-2xl font-bold text-white mb-6">Settings</h1>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg mx-auto">
                <h2 class="text-lg font-semibold text-white mb-4">Alert Feed Speed</h2>
                <div class="flex items-center space-x-4">
                    <span>Slow</span>
                    <input type="range" id="alert-speed-slider" min="2" max="30" value="14" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    <span>Fast</span>
                </div>
                <div class="text-center mt-2 text-gray-400">New alert every <span id="alert-speed-value">14</span> seconds (average)</div>
                <div class="mt-8 border-t border-gray-700 pt-6">
                     <h2 class="text-lg font-semibold text-white mb-4">Save & Load Progress</h2>
                     <div class="flex space-x-4">
                        <button id="save-progress-btn" class="w-full flex items-center justify-center py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-200"><i data-lucide="save" class="h-5 w-5 mr-2"></i>Save Progress</button>
                        <button id="load-progress-btn" class="w-full flex items-center justify-center py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-200"><i data-lucide="upload" class="h-5 w-5 mr-2"></i>Load Progress</button>
                        <input type="file" id="load-progress-input" class="hidden" accept=".progress">
                     </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Investigation Panel & Modals -->
    <div id="investigation-panel" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 w-full max-w-6xl h-full max-h-[90vh] rounded-2xl shadow-2xl flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-gray-700 shrink-0">
                <div class="flex items-center"><i data-lucide="file-text" class="h-6 w-6 text-indigo-400 mr-3"></i><h2 class="text-xl font-bold text-white">Investigate Alert: <span id="alert-id-display"></span></h2></div>
                <button id="close-panel-btn" class="text-gray-400 hover:text-white transition-colors"><i data-lucide="x" class="h-8 w-8"></i></button>
            </header>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/3 border-r border-gray-700 p-4 flex flex-col overflow-y-auto">
                    <h3 class="font-semibold text-lg text-white mb-4">Alert Details</h3>
                    <div id="alert-details-content" class="space-y-3 text-sm"></div>
                    <div class="mt-auto pt-4 border-t border-gray-700">
                        <h3 class="font-semibold text-lg text-white mb-4">Case Management</h3>
                        <div>
                            <label for="notes-textarea" class="block text-sm font-medium text-gray-300 mb-1">Investigation Notes</label>
                            <textarea id="notes-textarea" rows="4" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Add your findings..."></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button id="ai-analysis-btn" class="w-full flex items-center justify-center py-2 px-4 bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded-lg shadow-md transition-colors duration-200"><i data-lucide="brain-circuit" class="h-5 w-5 mr-2"></i>Initial Scan</button>
                            <button data-action="Escalate" class="action-btn w-full flex items-center justify-center py-2 px-4 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-lg shadow-md transition-colors duration-200"><i data-lucide="chevrons-up" class="h-5 w-5 mr-2"></i>Escalate</button>
                            <button data-action="False Positive" class="action-btn w-full flex items-center justify-center py-2 px-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg shadow-md transition-colors duration-200"><i data-lucide="shield-off" class="h-5 w-5 mr-2"></i>False Positive</button>
                             <button data-action="Resolve" class="action-btn w-full flex items-center justify-center py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-200"><i data-lucide="check-circle" class="h-5 w-5 mr-2"></i>Resolve</button>
                        </div>
                    </div>
                </div>
                <div class="w-2/3 flex flex-col bg-gray-900">
                     <div class="p-4 border-b border-gray-700"><h3 class="font-semibold text-lg text-white">Correlated Logs</h3></div>
                     <div id="log-viewer" class="flex-1 p-4 overflow-y-auto font-mono text-xs"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="modal-container">
        <div id="ai-modal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
            <div class="bg-gray-800 w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col border border-teal-500/50">
                 <header class="flex items-center justify-between p-4 border-b border-gray-700"><h2 class="text-xl font-bold text-white flex items-center"><i data-lucide="brain-circuit" class="h-6 w-6 text-teal-400 mr-3"></i>AI Analysis Report</h2><button data-close-modal="ai-modal" class="text-gray-400 hover:text-white transition-colors"><i data-lucide="x" class="h-8 w-8"></i></button></header>
                <div id="ai-content" class="p-6 space-y-4 text-gray-300 max-h-[70vh] overflow-y-auto"></div>
            </div>
        </div>
         <div id="evaluation-modal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
            <div class="bg-gray-800 w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col border border-indigo-500/50">
                 <header class="flex items-center justify-between p-4 border-b border-gray-700"><h2 class="text-xl font-bold text-white flex items-center"><i data-lucide="clipboard-check" class="h-6 w-6 text-indigo-400 mr-3"></i>Analyst Action Evaluation</h2><button data-close-modal="evaluation-modal" class="text-gray-400 hover:text-white transition-colors"><i data-lucide="x" class="h-8 w-8"></i></button></header>
                <div id="evaluation-content" class="p-6 space-y-4 text-gray-300 max-h-[70vh] overflow-y-auto"></div>
            </div>
        </div>
    </div>
    <div id="toast-container"></div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const ui = {}; // Will be populated in init()

        // --- SCENARIO DATABASE & DATA POOLS ---
        const dataPools = {
            usernames: ['j.smith', 'a.patel', 'm.garcia', 'l.chen', 'd.williams', 's.kim'],
            maliciousFilenames: ['Quarterly_Report_Urgent.pdf.exe', 'invoice_details.js', 'New-Adobe-Installer.vbs', 'Free_Bitcoin_Miner.scr', 'secure-document.docm'],
            maliciousHashes: ['a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6', 'f0e9d8c7b6a5a4b3c2d1e0f9a8b7c6d5', '9a8b7c6d5e4f3a2b1c0d9e8f7a6b5c4d', 'd4e5f6a1b2c3d4e5f6a7b8c9d0e1f2a3', 'c7b6a5f0e9d8c7b6a5a4b3c2d1e0f9a8'],
            c2Domains: ['update-microsoft.net', 'secure-login-portal.com', 'cdn-data-stream.xyz', 'sys-patch-srv.cc', 'office36O.live'],
            ipOwners: ['DigitalOcean, LLC', 'OVH SAS', 'Comcast Cable Communications, LLC', 'Google LLC', 'Amazon Web Services', 'Hetzner Online GmbH'],
            ipLocations: ['Ashburn, USA', 'Amsterdam, NL', 'Frankfurt, DE', 'Singapore, SG', 'San Francisco, USA', 'St. Petersburg, RU'],
            avEngines: ['BitDefender', 'McAfee', 'CrowdStrike', 'SentinelOne', 'Kaspersky', 'ESET', 'Avast', 'Sophos', 'TrendMicro'],
            malwareFamilies: ['TrickBot', 'Emotet', 'Ryuk', 'Cobalt Strike', 'Qakbot', 'Agent Tesla', 'Dridex'],
            achievements: {
                FIRST_CATCH: { title: 'First Catch', description: 'Resolve your first true positive alert.', unlocked: false },
                CASE_CLOSED: { title: 'Case Closed', description: 'Resolve 10 true positive alerts.', unlocked: false },
                SHERLOCK: { title: 'Sherlock', description: 'Correctly identify 5 false positives.', unlocked: false },
                THREAT_HUNTER: { title: 'Threat Hunter', description: 'Use the Threat Intel tool 10 times.', unlocked: false },
                CHAIN_OF_COMMAND: { title: 'Chain of Command', description: 'Escalate a critical alert correctly.', unlocked: false }
            }
        };

        const SCENARIOS = {
            'Malware Detected': {
                severity: 'Critical', isThreat: true,
                details: (src, dest) => ({ user: getRandomItem(dataPools.usernames), filename: getRandomItem(dataPools.maliciousFilenames), hash: getRandomItem(dataPools.maliciousHashes), c2: getRandomItem(dataPools.c2Domains), victimIp: dest }),
                description: (details) => `Malware detected on host ${details.victimIp} associated with user ${details.user}`,
                logs: (alert, h) => [
                    generateLogLine(alert.timestamp - 30000, 'EmailGateway', `Email received from external source with attachment: ${h(alert.details.filename)}`),
                    generateLogLine(alert.timestamp - 5000, 'Endpoint-Security', `User ${h(alert.details.user)} downloaded file ${h(alert.details.filename)} to C:\\Users\\${alert.details.user}\\Downloads`),
                    generateLogLine(alert.timestamp - 1000, 'Endpoint-Security', `Process created by explorer.exe: ${h('powershell.exe')} with args "-enc ..."`),
                    generateLogLine(alert.timestamp, 'Endpoint-Security', `[ALERT] Malicious process detected. Signature: Gen:Variant.Ursnif.123. File Hash: ${h(alert.details.hash)}. Action: Process Terminated.`),
                    generateLogLine(alert.timestamp + 500, 'DNS-Firewall', `DNS query for ${h(alert.details.c2)} from host ${h(alert.details.victimIp)}`),
                    generateLogLine(alert.timestamp + 700, 'PaloAlto-FW', `Traffic from ${h(alert.details.victimIp)} to ${h(alert.src_ip)} on port 443 blocked. Reason: C2_Domain_Match (${alert.details.c2})`),
                ]
            },
            'Brute Force Attempt': {
                severity: 'High', isThreat: true,
                details: () => ({ targetUser: 'root', targetService: 'SSH' }),
                description: (details, src) => `Multiple failed login attempts for user ${details.targetUser} from source ${src}`,
                logs: (alert, h) => {
                    let log_entries = [];
                    for (let i = 5; i > 0; i--) { log_entries.push(generateLogLine(alert.timestamp - (i * 2000), 'SSHD', `Failed password for ${h(alert.details.targetUser)} from ${h(alert.src_ip)} port 45822 ssh2`)); }
                    log_entries.push(generateLogLine(alert.timestamp, 'SSHD', `[ALERT] Multiple failed login attempts for user ${h(alert.details.targetUser)} from ${h(alert.src_ip)}. Possible brute force.`));
                    return log_entries;
                }
            },
            'SQL Injection Attempt': {
                severity: 'High', isThreat: true,
                details: () => ({ payload: "' OR '1'='1" }),
                description: (details, src) => `SQL Injection attempt detected from ${src}`,
                logs: (alert, h) => [
                    generateLogLine(alert.timestamp, 'Nginx-WAF', `[ALERT] SQL Injection attempt blocked from IP ${h(alert.src_ip)}. Request: GET /products?id=${h(alert.details.payload)}`),
                    generateLogLine(alert.timestamp, 'Nginx-Access', `${alert.src_ip} - - [${new Date(alert.timestamp).toUTCString()}] "GET /products?id=1%27%20OR%20%271%27%3D%271 HTTP/1.1" 403 153 "-" "sqlmap/1.5"`),
                ]
            },
            'Data Exfiltration': {
                severity: 'Critical', isThreat: true,
                details: (src, dest) => ({ user: getRandomItem(dataPools.usernames), dataSize: (Math.random() * 50 + 50).toFixed(2), destination: 'pastebin.com', victimIp: src }),
                description: (details) => `Large upload of ${details.dataSize}MB to external site from ${details.user}'s machine`,
                logs: (alert, h) => [
                    generateLogLine(alert.timestamp - 60000, 'Endpoint-DLP', `User ${h(alert.details.user)} accessed file: C:\\Data\\Financial_Projections_Q3.xlsx`),
                    generateLogLine(alert.timestamp - 5000, 'Endpoint-DLP', `User ${h(alert.details.user)} created archive file: C:\\Users\\${alert.details.user}\\temp\\archive.zip`),
                    generateLogLine(alert.timestamp, 'PaloAlto-FW', `[ALERT] Large HTTP POST detected from ${h(alert.details.victimIp)} to ${h(alert.dest_ip)}. Size: ${alert.details.dataSize}MB. Destination Host: ${h(alert.details.destination)}. Category: File Sharing.`),
                ]
            },
            'Impossible Travel': {
                severity: 'Medium', isThreat: true,
                details: () => ({ user: getRandomItem(dataPools.usernames), location1: 'USA', location2: 'Netherlands', ip2: generateRandomIp() }),
                description: (details) => `Impossible travel detected for user ${details.user}`,
                logs: (alert, h) => [
                    generateLogLine(alert.timestamp - 120000, 'AzureAD', `Successful login for user ${h(alert.details.user)} from IP ${h(alert.src_ip)}. Location: ${h(alert.details.location1)}`),
                    generateLogLine(alert.timestamp, 'AzureAD', `[ALERT] Successful login for user ${h(alert.details.user)} from IP ${h(alert.details.ip2)}. Location: ${h(alert.details.location2)}. Flag: Impossible Travel.`),
                ]
            },
            'Port Scan': {
                severity: 'Low', isThreat: true,
                details: () => ({ portCount: Math.floor(Math.random() * 200) + 50 }),
                description: (details, src) => `Port scan detected from ${src}, ${details.portCount} ports scanned`,
                logs: (alert, h) => [
                    generateLogLine(alert.timestamp, 'PaloAlto-FW', `[ALERT] A port scan was detected from host ${h(alert.src_ip)} targeting ${h(alert.dest_ip)}. ${h(alert.details.portCount)} ports were scanned in a short period.`),
                    generateLogLine(alert.timestamp + 100, 'PaloAlto-FW', `Traffic from ${h(alert.src_ip)} to ${h(alert.dest_ip)} on port 22 denied.`),
                    generateLogLine(alert.timestamp + 120, 'PaloAlto-FW', `Traffic from ${h(alert.src_ip)} to ${h(alert.dest_ip)} on port 80 denied.`),
                    generateLogLine(alert.timestamp + 150, 'PaloAlto-FW', `Traffic from ${h(alert.src_ip)} to ${h(alert.dest_ip)} on port 443 denied.`),
                ]
            },
            'User Login Success': {
                severity: 'Informational', isThreat: false,
                details: () => ({ user: getRandomItem(dataPools.usernames) }),
                description: (details) => `Successful login for user ${details.user}`,
                logs: (alert, h) => [generateLogLine(alert.timestamp, 'Auth', `User ${h(alert.details.user)} logged in successfully from ${h(alert.src_ip)}.`)]
            }
        };

        // --- STATE MANAGEMENT ---
        let state = {
            alerts: [],
            alertCounter: 0,
            activeView: 'dashboard',
            activeAlertId: null,
            feedTimeout: null,
            isFeedPaused: false,
            settings: { alertSpeed: 14 },
            charts: {},
            kpis: { resolvedTimes: [] },
            playerProfile: {
                level: 1,
                xp: 0,
                nextLevelXp: 100,
                achievements: JSON.parse(JSON.stringify(dataPools.achievements)), // Deep copy
                stats: {
                    resolved: 0,
                    falsePositives: 0,
                    escalated: 0,
                    intelLookups: 0
                }
            }
        };

        // --- CORE LOGIC ---
        const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const generateRandomIp = (isInternal = false) => {
            if (isInternal) return `10.10.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`;
            return `${Math.floor(Math.random() * 223) + 1}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`;
        };
        const highlight = (text) => `<span class="highlight">${text}</span>`;
        const generateLogLine = (timestamp, source, message) => `<div class="log-line"><span class="timestamp">${new Date(timestamp).toISOString()}</span><span class="source">[${source}]</span><span class="message">${message}</span></div>`;


        function createAlert() {
            if (state.isFeedPaused) return;

            const scenarioKeys = Object.keys(SCENARIOS);
            const type = getRandomItem(scenarioKeys);
            const scenario = SCENARIOS[type];
            let src_ip = generateRandomIp();
            let dest_ip = generateRandomIp(true);

            if(type === 'Data Exfiltration') { src_ip = generateRandomIp(true); dest_ip = generateRandomIp(false); }
            if(type === 'SQL Injection Attempt' || type === 'Brute Force Attempt') { dest_ip = '203.0.113.88'; }
            
            const details = scenario.details(src_ip, dest_ip);
            const newAlert = {
                id: ++state.alertCounter,
                status: 'New',
                severity: scenario.severity,
                timestamp: Date.now(),
                type: type,
                src_ip: src_ip,
                dest_ip: dest_ip,
                notes: '',
                isThreat: scenario.isThreat,
                description: scenario.description(details, src_ip, dest_ip),
                details: details,
                resolvedTimestamp: null
            };

            state.alerts.unshift(newAlert);
            if (state.alerts.length > 500) state.alerts.pop();
            
            if (state.activeView === 'alerts') renderAlerts();
            if (state.activeView === 'dashboard') updateDashboard();
            updateAlertCount();

            const baseSpeed = state.settings.alertSpeed * 1000;
            const nextAlertTime = Math.random() * baseSpeed + (baseSpeed / 2);
            state.feedTimeout = setTimeout(createAlert, nextAlertTime);
        }

        function generateDetailedLogs(alert) {
            const scenario = SCENARIOS[alert.type];
            if (scenario && scenario.logs) return scenario.logs(alert, highlight).join('');
            return generateLogLine(alert.timestamp, 'GenericLog', `Log for alert #${alert.id}. Details: ${alert.description}`);
        }

        async function getGeminiEvaluation(alert, analystNotes, analystAction) {
            ui.evaluationContent.innerHTML = `<div class="flex justify-center items-center p-8"><div class="loader"></div></div>`;
            ui.evaluationModal.classList.remove('hidden');
            const prompt = `As a senior cybersecurity analyst trainer, evaluate this incident response. Incident Type: ${alert.type}. Real Threat: ${alert.isThreat}. Analyst Action: '${analystAction}'. Notes: "${analystNotes || 'None'}". Your Task: Provide a "Score: X/10", a one-sentence "Evaluation:", and a one-sentence "Recommendation:". Be concise.`;
            try {
                const apiKey = "API_KEY_HERE";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed`);
                const result = await response.json();
                ui.evaluationContent.innerHTML = result.candidates[0].content.parts[0].text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                ui.evaluationContent.innerHTML = `<p class="text-red-400"><strong>Evaluation Failed.</strong></p>`;
            }
        }

        function getRichIndicatorReputation(indicator) {
            ui.unifiedLookupResults.innerHTML = '';
            ui.unifiedLookupResults.classList.remove('hidden');

            const ipRegex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
            const hashRegex = /^[a-f0-9]{32,}$/i;
            const domainRegex = /^(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+[a-z0-9][a-z0-9-]{0,61}[a-z0-9]$/i;
            
            let type = 'unknown';
            if (ipRegex.test(indicator)) type = 'ip';
            else if (hashRegex.test(indicator)) type = 'hash';
            else if (domainRegex.test(indicator) || indicator.includes('.')) type = 'domain';

            let report = {};
            let isMalicious = state.alerts.some(a => a.isThreat && (Object.values(a).includes(indicator) || Object.values(a.details).includes(indicator)));
            
            if (type === 'ip') {
                const relatedAlerts = state.alerts.filter(a => (a.src_ip === indicator || a.dest_ip === indicator) && a.isThreat);
                isMalicious = relatedAlerts.length > 0;
                report = {
                    Owner: getRandomItem(dataPools.ipOwners),
                    Location: getRandomItem(dataPools.ipLocations),
                    Tags: isMalicious ? ['Known Scanner', 'Malicious C2'] : ['Cloud Provider', 'Benign'],
                    History: relatedAlerts.map(a => `Associated with '${a.type}' on ${new Date(a.timestamp).toLocaleDateString()}`)
                };
            } else if (type === 'hash' || type === 'domain') {
                 isMalicious = state.alerts.some(a => a.details && (a.details.hash === indicator || a.details.c2 === indicator || a.details.filename === indicator));
                report = {
                    'First Seen': new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                    'Detections': [],
                };
                if (isMalicious) {
                    for(let i=0; i < (Math.random() * 5 + 2); i++) {
                        report.Detections.push(`${getRandomItem(dataPools.avEngines)}: Trojan.${getRandomItem(dataPools.malwareFamilies)}.gen`);
                    }
                }
            } else {
                 ui.unifiedLookupResults.innerHTML = `<p class="text-yellow-400">Unknown indicator type. Please enter a valid IP, Domain, or Hash.</p>`;
                 return;
            }

            let resultHtml = `<div class="bg-gray-900 p-4 rounded-lg mt-4 border ${isMalicious ? 'border-red-500' : 'border-green-500'}">
                <h3 class="font-bold text-lg ${isMalicious ? 'text-red-400' : 'text-green-400'}">${isMalicious ? 'Malicious' : 'Clean'} (${(Math.random() * 30 + (isMalicious ? 60:0)).toFixed(0)}/100)</h3>
                <p class="font-mono text-sm break-all">${indicator}</p>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">`;

            for(const [key, value] of Object.entries(report)) {
                resultHtml += `<div><p class="text-gray-400 font-semibold">${key}</p>`;
                if (Array.isArray(value) && value.length > 0) {
                    resultHtml += `<ul class="list-disc list-inside">${value.map(v => `<li class="text-gray-300">${v}</li>`).join('')}</ul>`;
                } else if(Array.isArray(value) && value.length === 0){
                    resultHtml += `<p class="text-gray-300">None</p>`
                } else {
                     resultHtml += `<p class="text-gray-300">${value}</p>`;
                }
                resultHtml += '</div>';
            }

            resultHtml += '</div></div>';
            ui.unifiedLookupResults.innerHTML = resultHtml;
        }
        
        // --- RENDERING & UI ---
        function renderAll() {
            renderAlerts();
            updateDashboard();
            updateProfileView();
            updateAlertCount();
        }

        function renderAlerts() {
             ui.alertsTableBody.innerHTML = state.alerts.map(alert => {
                let severityClass, statusClass;
                switch (alert.severity) {
                    case 'Critical': severityClass = 'bg-red-900 text-red-300'; break;
                    case 'High': severityClass = 'bg-orange-800 text-orange-300'; break;
                    case 'Medium': severityClass = 'bg-yellow-800 text-yellow-300'; break;
                    case 'Low': severityClass = 'bg-blue-900 text-blue-300'; break;
                    default: severityClass = 'bg-gray-700 text-gray-400'; break;
                }
                switch (alert.status) {
                    case 'New': statusClass = 'text-blue-400'; break;
                    case 'In Progress': statusClass = 'text-yellow-400'; break;
                    case 'Resolved': case 'False Positive': statusClass = 'text-green-400'; break;
                    case 'Escalated': statusClass = 'text-amber-400'; break;
                }
                return `<tr class="bg-gray-800/50 hover:bg-gray-700/60 border-b border-gray-700 cursor-pointer" data-alert-id="${alert.id}"><td class="px-6 py-4 font-semibold ${statusClass}">${alert.status}</td><td class="px-6 py-4"><span class="px-2 py-1 text-xs font-bold rounded-full ${severityClass}">${alert.severity}</span></td><td class="px-6 py-4 font-mono text-xs">${new Date(alert.timestamp).toLocaleString()}</td><td class="px-6 py-4">${alert.description}</td><td class="px-6 py-4 font-mono text-xs">${alert.src_ip}</td><td class="px-6 py-4 font-mono text-xs">${alert.dest_ip}</td></tr>`;
            }).join('');
            document.querySelectorAll('#alerts-table-body tr').forEach(row => {
                row.addEventListener('click', () => openInvestigationPanel(row.dataset.alertId));
            });
        }

        function updateAlertCount() {
            const newAlerts = state.alerts.filter(a => a.status === 'New').length;
            ui.alertCountBadge.textContent = newAlerts;
            ui.alertCountBadge.classList.toggle('hidden', newAlerts === 0);
        }

        function renderInvestigationPanel(alert) {
            ui.alertIdDisplay.textContent = `#${alert.id}`;
            let detailsHtml = `<p><strong>ID:</strong> ${alert.id}</p><p><strong>Timestamp:</strong> ${new Date(alert.timestamp).toLocaleString()}</p><p><strong>Severity:</strong> ${alert.severity}</p><p><strong>Type:</strong> ${alert.type}</p><p><strong>Description:</strong> ${alert.description}</p><p><strong>Source IP:</strong> <span class="font-mono">${alert.src_ip}</span></p><p><strong>Destination IP:</strong> <span class="font-mono">${alert.dest_ip}</span></p>`;
            if(alert.details.user) detailsHtml += `<p><strong>User:</strong> ${alert.details.user}</p>`;
            if(alert.details.filename) detailsHtml += `<p><strong>Filename:</strong> <span class="font-mono break-all">${alert.details.filename}</span></p>`;
            if(alert.details.hash) detailsHtml += `<p><strong>Hash:</strong> <span class="font-mono text-xs break-all">${alert.details.hash}</span></p>`;
            ui.alertDetailsContent.innerHTML = detailsHtml;
            ui.notesTextarea.value = alert.notes;
            ui.logViewer.innerHTML = generateDetailedLogs(alert);
        }

        function updateDashboard() {
            if (state.activeView !== 'dashboard') return;
            const now = Date.now();
            const twentyFourHoursAgo = now - 24 * 60 * 60 * 1000;
            const recentAlerts = state.alerts.filter(a => a.timestamp > twentyFourHoursAgo);

            ui.kpiTotalAlerts.textContent = recentAlerts.length;
            ui.kpiOpenCases.textContent = state.alerts.filter(a => a.status === 'In Progress' || a.status === 'New').length;
            if (state.kpis.resolvedTimes.length > 0) {
                const avgSeconds = state.kpis.resolvedTimes.reduce((a, b) => a + b, 0) / state.kpis.resolvedTimes.length;
                ui.kpiAvgResolution.textContent = avgSeconds > 60 ? `${(avgSeconds / 60).toFixed(1)} min` : `${avgSeconds.toFixed(0)} sec`;
            } else {
                ui.kpiAvgResolution.textContent = 'N/A';
            }

            updateSeverityChart(recentAlerts);
            updateTimelineChart(recentAlerts);

            const updateList = (element, data, property) => {
                const counts = data.reduce((acc, item) => {
                    const key = item[property];
                    if (key) acc[key] = (acc[key] || 0) + 1;
                    return acc;
                }, {});
                const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 5);
                element.innerHTML = sorted.map(([key, count]) => `<li class="flex justify-between items-center text-gray-300"><span>${key}</span><span class="font-bold text-indigo-400">${count}</span></li>`).join('');
            };

            updateList(ui.topAttackersList, recentAlerts.filter(a=>a.isThreat), 'src_ip');
            updateList(ui.topTargetsList, recentAlerts.filter(a=>a.isThreat), 'dest_ip');

            ui.recentCasesList.innerHTML = state.alerts.filter(a => a.severity === 'Critical' || a.severity === 'High').slice(0, 5)
                .map(a => `<li class="text-gray-300 cursor-pointer hover:text-white" data-alert-id="${a.id}">#${a.id}: ${a.description}</li>`).join('');
        }

        function updateSeverityChart(data) {
             const severityCounts = data.reduce((acc, alert) => { acc[alert.severity] = (acc[alert.severity] || 0) + 1; return acc; }, {});
             if (state.charts.severity) {
                state.charts.severity.data.labels = Object.keys(severityCounts);
                state.charts.severity.data.datasets[0].data = Object.values(severityCounts);
                state.charts.severity.update();
            }
        }
        function updateTimelineChart(data) {
            const timelineData = data.reduce((acc, alert) => {
                const hour = new Date(alert.timestamp).setMinutes(0, 0, 0);
                const entry = acc.find(e => e.x === hour);
                if(entry) { entry.y++; } else { acc.push({x: hour, y: 1}); }
                return acc;
            }, []);
            if (state.charts.timeline) {
                state.charts.timeline.data.datasets[0].data = timelineData;
                state.charts.timeline.update();
            }
        }
        
        function updateProfileView() {
            const profile = state.playerProfile;
            ui.profileLevel.textContent = profile.level;
            ui.profileXpText.textContent = `${profile.xp} / ${profile.nextLevelXp} XP`;
            ui.profileXpBar.style.width = `${(profile.xp / profile.nextLevelXp) * 100}%`;
            
            ui.achievementsList.innerHTML = Object.entries(profile.achievements).map(([key, ach]) => `
                <li class="flex items-center gap-4 ${ach.unlocked ? 'opacity-100' : 'opacity-40'}">
                    <div class="p-2 bg-gray-700 rounded-md">
                        <i data-lucide="award" class="${ach.unlocked ? 'text-yellow-400' : 'text-gray-500'}"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-white">${ach.title}</h3>
                        <p class="text-sm text-gray-400">${ach.description}</p>
                    </div>
                </li>
            `).join('');
            lucide.createIcons();
        }

        // --- EVENT HANDLERS & ACTIONS ---
        function switchView(viewName) {
            state.activeView = viewName;
            ui.views.forEach(view => view.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            ui.navLinks.forEach(link => link.classList.toggle('active', link.dataset.view === viewName));
            if (viewName === 'dashboard') updateDashboard();
            if (viewName === 'profile') updateProfileView();
        }

        function openInvestigationPanel(alertId) {
            state.activeAlertId = parseInt(alertId);
            const alert = state.alerts.find(a => a.id == state.activeAlertId);
            if (alert) {
                renderInvestigationPanel(alert);
                if (alert.status === 'New') {
                    alert.status = 'In Progress';
                    addXp(2); // XP for opening an alert
                }
                renderAlerts();
                ui.investigationPanel.classList.remove('hidden');
            }
        }

        function closeInvestigationPanel() {
            ui.investigationPanel.classList.add('hidden');
            state.activeAlertId = null;
        }

        async function handleAnalystAction(e) {
            const action = e.currentTarget.dataset.action;
            const alert = state.alerts.find(a => a.id === state.activeAlertId);
            if (!alert) return;
            
            alert.notes = ui.notesTextarea.value;
            alert.status = action;
            let correctAction = false;
            
            if (action === 'Resolve' && alert.isThreat) { 
                state.playerProfile.stats.resolved++;
                addXp(10);
                correctAction = true;
            } else if (action === 'False Positive' && !alert.isThreat) {
                state.playerProfile.stats.falsePositives++;
                addXp(15);
                correctAction = true;
            } else if (action === 'Escalate' && alert.severity === 'Critical') {
                state.playerProfile.stats.escalated++;
                addXp(20);
                correctAction = true;
            } else {
                addXp(1); // Consolation XP
            }

            if (correctAction) checkAchievements(action, alert);

            if (action === 'Resolve' || action === 'False Positive') {
                alert.resolvedTimestamp = Date.now();
                state.kpis.resolvedTimes.push((alert.resolvedTimestamp - alert.timestamp) / 1000);
            }

            closeInvestigationPanel();
            renderAll();
            await getGeminiEvaluation(alert, alert.notes, action);
        }

        function toggleFeed() {
            state.isFeedPaused = !state.isFeedPaused;
            if (state.isFeedPaused) {
                clearTimeout(state.feedTimeout);
                ui.toggleFeedBtn.textContent = 'Resume Feed';
                ui.toggleFeedBtn.classList.replace('bg-indigo-600', 'bg-green-600');
                ui.feedStatusIndicator.classList.remove('bg-green-500', 'blinking-dot');
                ui.feedStatusIndicator.classList.add('bg-gray-500');
                ui.feedStatusText.textContent = 'Feed Paused';
            } else {
                createAlert();
                ui.toggleFeedBtn.textContent = 'Pause Feed';
                ui.toggleFeedBtn.classList.replace('bg-green-600', 'bg-indigo-600');
                ui.feedStatusIndicator.classList.add('bg-green-500', 'blinking-dot');
                ui.feedStatusIndicator.classList.remove('bg-gray-500');
                ui.feedStatusText.textContent = 'Real-time Feed Active';
            }
        }
        function handleLogSearch() { 
            const query = ui.searchQueryInput.value.trim().toLowerCase();
            if (!query) return;
            const results = state.alerts.filter(alert => {
                return JSON.stringify(alert).toLowerCase().includes(query) || generateDetailedLogs(alert).toLowerCase().includes(query);
            });
            
            const resultsContainer = ui.searchResultsContainer.querySelector('pre');
            if (results.length > 0) {
                let resultText = '';
                results.forEach(alert => {
                    resultText += `--- Alert #${alert.id} ---\n`;
                    resultText += JSON.stringify(alert, null, 2);
                    resultText += '\n--- Correlated Logs ---\n';
                    resultText += generateDetailedLogs(alert).replace(/<[^>]*>?/gm, ''); // strip html for pre
                    resultText += '\n\n';
                });
                resultsContainer.textContent = resultText;
            } else {
                resultsContainer.textContent = `No logs found matching query: "${query}"`;
            }
            ui.searchResultsContainer.classList.remove('hidden');
        }
        function handleAiAnalysis() {
            const alert = state.alerts.find(a => a.id === state.activeAlertId);
            if (alert) {
                ui.aiContent.innerHTML = '<div class="flex justify-center items-center p-8"><div class="loader"></div></div>';
                ui.aiModal.classList.remove('hidden');
                
                setTimeout(() => { // Simulate API call delay
                    const scenario = SCENARIOS[alert.type];
                    // Basic analysis, can be expanded
                    ui.aiContent.innerHTML = `This is a <strong>${alert.severity}</strong> severity alert. It is considered ${alert.isThreat ? 'a threat' : 'benign'}. Key indicators are source IP ${alert.src_ip} and destination ${alert.dest_ip}.`;
                }, 1000);
            }
        }
        function handleAlertSpeedChange(e) {
            const speed = parseInt(e.target.value);
            state.settings.alertSpeed = 32 - speed; // Invert so right is faster
            ui.alertSpeedValue.textContent = state.settings.alertSpeed;
        }

        // --- GAMIFICATION ---
        function addXp(amount) {
            state.playerProfile.xp += amount;
            showNotification(`+${amount} XP`, 'info');
            if (state.playerProfile.xp >= state.playerProfile.nextLevelXp) {
                state.playerProfile.level++;
                state.playerProfile.xp -= state.playerProfile.nextLevelXp;
                state.playerProfile.nextLevelXp = Math.floor(state.playerProfile.nextLevelXp * 1.5);
                showNotification(`Level Up! You are now Level ${state.playerProfile.level}!`, 'success');
            }
            updateProfileView();
        }

        function checkAchievements(action, alert) {
            const achievements = state.playerProfile.achievements;
            const stats = state.playerProfile.stats;
            if (!achievements.FIRST_CATCH.unlocked && action === 'Resolve' && alert.isThreat) {
                achievements.FIRST_CATCH.unlocked = true;
                showNotification('Achievement Unlocked: First Catch!', 'success');
            }
            if (!achievements.CASE_CLOSED.unlocked && stats.resolved >= 10) {
                achievements.CASE_CLOSED.unlocked = true;
                showNotification('Achievement Unlocked: Case Closed!', 'success');
            }
            if (!achievements.SHERLOCK.unlocked && stats.falsePositives >= 5) {
                achievements.SHERLOCK.unlocked = true;
                showNotification('Achievement Unlocked: Sherlock!', 'success');
            }
            if (!achievements.CHAIN_OF_COMMAND.unlocked && action === 'Escalate' && alert.severity === 'Critical') {
                achievements.CHAIN_OF_COMMAND.unlocked = true;
                showNotification('Achievement Unlocked: Chain of Command!', 'success');
            }
            if (!achievements.THREAT_HUNTER.unlocked && stats.intelLookups >= 10) {
                achievements.THREAT_HUNTER.unlocked = true;
                showNotification('Achievement Unlocked: Threat Hunter!', 'success');
            }
        }

        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            const icon = type === 'success' ? 'party-popper' : 'info';
            toast.className = 'toast';
            toast.innerHTML = `<i data-lucide="${icon}" class="h-6 w-6 mr-3 ${type === 'success' ? 'text-green-400' : 'text-blue-400'}"></i><span>${message}</span>`;
            ui.toastContainer.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => { toast.classList.add('show'); }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000);
        }

        // --- SAVE/LOAD ---
        const encryptionKey = 'SOC-SIM-SECRET-KEY';
        const xorEncryptDecrypt = (str, key) => {
            return str.split('').map((char, i) => String.fromCharCode(char.charCodeAt(0) ^ key.charCodeAt(i % key.length))).join('');
        };

        function getSaveState() {
            return {
                version: '1.0',
                alerts: state.alerts,
                alertCounter: state.alertCounter,
                kpis: state.kpis,
                playerProfile: state.playerProfile,
                settings: state.settings,
            };
        }

        function loadState(loadedState) {
            if (loadedState.version !== '1.0') {
                showNotification('Error: Incompatible save file version.', 'error');
                return;
            }
            state.alerts = loadedState.alerts;
            state.alertCounter = loadedState.alertCounter;
            state.kpis = loadedState.kpis;
            state.playerProfile = loadedState.playerProfile;
            state.settings = loadedState.settings;

            // Ensure nested achievement object is present if loading older save
            if (!state.playerProfile.achievements) {
                state.playerProfile.achievements = JSON.parse(JSON.stringify(dataPools.achievements));
            }
            
            ui.alertSpeedSlider.value = 32 - state.settings.alertSpeed;
            ui.alertSpeedValue.textContent = state.settings.alertSpeed;

            renderAll();
            showNotification('Progress loaded successfully!', 'success');
        }

        function handleSaveProgress() {
            const stateToSave = getSaveState();
            const jsonString = JSON.stringify(stateToSave);
            const encryptedString = xorEncryptDecrypt(jsonString, encryptionKey);
            const blob = new Blob([encryptedString], {type: 'application/octet-stream'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().slice(0, 10);
            a.download = `soc-sim_${date}.progress`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Progress saved!', 'success');
        }

        function handleLoadProgress() {
            ui.loadProgressInput.click();
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const decryptedString = xorEncryptDecrypt(e.target.result, encryptionKey);
                    const loadedState = JSON.parse(decryptedString);
                    loadState(loadedState);
                } catch (err) {
                    showNotification('Error: Could not load file. It may be corrupted.', 'error');
                    console.error("Load error:", err);
                }
            };
            reader.readAsText(file);
        }

        // --- INITIALIZATION ---
        function init() {
            const ids = ['alerts-table-body', 'alert-count-badge', 'investigation-panel', 'close-panel-btn', 'alert-id-display', 'alert-details-content', 'notes-textarea', 'log-viewer', 'ai-analysis-btn', 'modal-container', 'ai-modal', 'ai-content', 'evaluation-modal', 'evaluation-content', 'toggle-feed-btn', 'feed-status-indicator', 'feed-status-text', 'search-query-input', 'search-logs-btn', 'search-results-container', 'unified-lookup-input', 'unified-lookup-btn', 'unified-lookup-results', 'alert-speed-slider', 'alert-speed-value', 'kpi-total-alerts', 'kpi-open-cases', 'kpi-avg-resolution', 'top-attackers-list', 'top-targets-list', 'recent-cases-list', 'profile-level', 'profile-xp-bar', 'profile-xp-text', 'achievements-list', 'save-progress-btn', 'load-progress-btn', 'load-progress-input', 'toast-container'];
            ids.forEach(id => ui[id.replace(/-(\w)/g, (m, g) => g.toUpperCase())] = document.getElementById(id));
            ui.views = document.querySelectorAll('.view');
            ui.navLinks = document.querySelectorAll('.nav-link');
            ui.actionBtns = document.querySelectorAll('.action-btn');

            lucide.createIcons();
            
            const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#d1d5db' } } } };
            state.charts.severity = new Chart(document.getElementById('severityChart'), { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#ef4444', '#f97316', '#eab308', '#3b82f6', '#6b7280'] }] }, options: chartOptions });
            state.charts.timeline = new Chart(document.getElementById('timelineChart'), {
                type: 'line',
                data: { datasets: [{ label: 'Alerts', data: [], borderColor: '#4f46e5', tension: 0.1, fill: false }] },
                options: { ...chartOptions, scales: { x: { type: 'time', time: { unit: 'hour' }, ticks: { color: '#d1d5db' } }, y: { ticks: { color: '#d1d5db' }, beginAtZero: true } } }
            });

            ui.navLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); switchView(link.dataset.view); }));
            ui.closePanelBtn.addEventListener('click', closeInvestigationPanel);
            ui.modalContainer.addEventListener('click', (e) => {
                const modalId = e.target.closest('[data-close-modal]')?.dataset.closeModal;
                if (modalId) document.getElementById(modalId).classList.add('hidden');
            });
            ui.recentCasesList.addEventListener('click', (e) => { if (e.target.tagName === 'LI' && e.target.dataset.alertId) openInvestigationPanel(e.target.dataset.alertId); });
            ui.aiAnalysisBtn.addEventListener('click', handleAiAnalysis);
            ui.actionBtns.forEach(btn => btn.addEventListener('click', handleAnalystAction));
            ui.toggleFeedBtn.addEventListener('click', toggleFeed);
            ui.searchLogsBtn.addEventListener('click', handleLogSearch);
            ui.searchQueryInput.addEventListener('keyup', (e) => { if(e.key === 'Enter') handleLogSearch(); });
            ui.unifiedLookupBtn.addEventListener('click', () => { getRichIndicatorReputation(ui.unifiedLookupInput.value); state.playerProfile.stats.intelLookups++; checkAchievements(); });
            ui.unifiedLookupInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') { getRichIndicatorReputation(ui.unifiedLookupInput.value); state.playerProfile.stats.intelLookups++; checkAchievements(); } });
            ui.alertSpeedSlider.addEventListener('input', handleAlertSpeedChange);
            ui.saveProgressBtn.addEventListener('click', handleSaveProgress);
            ui.loadProgressBtn.addEventListener('click', handleLoadProgress);
            ui.loadProgressInput.addEventListener('change', handleFileLoad);
            
            switchView('dashboard');
            createAlert();
        }

        init();
    });
    </script>
</body>
</html>
